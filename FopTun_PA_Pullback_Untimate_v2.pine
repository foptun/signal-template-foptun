//@version=5
// -----------------------------------------------------------------------------
// Strategy Name: 1m Price Action Trend Pullback Strategy (Enhanced + TDI Bands + Trailing Stop + Sessions)
// Description:
// This strategy uses EMA Crossover (21/50) to identify the main trend
// and uses a Pullback to the Fast EMA (21) as an entry signal.
//
// Features:
// - Fixed Stop Loss (ATR) and Risk/Reward Ratio (RR)
// - Commission setting input
// - Sideways Filter using ADX
// - Volume Filter (Yellow signal if volume is low)
// - TDI Trend Filter (Market Base Line)
// - TDI Volatility Bands (BB on RSI) to avoid Overbought/Oversold entries
// - Trailing Stop System (ATR Based)
// - (NEW) Session Backgrounds (Asia, London, New York)
// -----------------------------------------------------------------------------

// --- 1. SETTINGS (INPUTS) ---

// Strategy Settings
grp_strat = "Strategy Settings"
commission_input = input.float(0.0, "Commission (%)", minval=0, step=0.001, group=grp_strat)

// Moving Averages
grp_ma = "Moving Averages"
fast_len = input.int(14, "Fast EMA Length", group=grp_ma)
slow_len = input.int(60, "Slow EMA Length", group=grp_ma)

// Stop Loss / Take Profit (Fixed)
grp_exit = "Stop Loss / Take Profit"
atr_len = input.int(14, "ATR Length", group=grp_exit)
sl_multiplier = input.float(1.5, "Stop Loss (ATR Multiplier)", step=0.1, group=grp_exit)
rr_ratio = input.float(20, "Risk/Reward Ratio (RR)", step=0.1, group=grp_exit)

// Trailing Stop Settings
grp_trail = "Trailing Stop Settings"
use_trailing = input.bool(true, "Use Trailing Stop", group=grp_trail)
trail_activation_mult = input.float(0.1, "Activation (ATR Multiplier)", step=0.01, tooltip="Price must move this many ATRs in profit to activate trailing.", group=grp_trail)
trail_offset_mult = input.float(0.01, "Trailing Offset (ATR Multiplier)", step=0.01, tooltip="Distance of the trailing stop behind the price.", group=grp_trail)

// Sideways Filter (ADX)
grp_filter = "Sideways Filter (ADX)"
use_adx_filter = input.bool(false, "Use ADX Filter", group=grp_filter)
dmi_len = input.int(14, "DMI Length", group=grp_filter)
adx_smoothing_len = input.int(14, "ADX Smoothing Length", group=grp_filter)
adx_threshold = input.int(20, "ADX Threshold (Trade above this)", group=grp_filter)

// Volume Filter
grp_vol = "Volume Filter"
use_volume_filter = input.bool(true, "Use Volume Filter (Yellow Signal)", group=grp_vol)
volume_ma_len = input.int(40, "Volume MA Length", group=grp_vol)

// TDI Trend Filter
grp_tdi = "TDI Trend Filter"
use_tdi_filter = input.bool(true, "Use TDI Trend Filter", group=grp_tdi)
tdi_rsi_len = input.int(14, "TDI: RSI Length", group=grp_tdi)
tdi_price_len = input.int(2, "TDI: Price Line (Fast MA)", group=grp_tdi)
tdi_mbl_len = input.int(34, "TDI: Market Base Line (Mid MA)", group=grp_tdi)

// TDI Volatility Bands
use_tdi_band_filter = input.bool(true, "Use TDI Volatility Bands Filter", group=grp_tdi)
tdi_band_len = input.int(35, "TDI: Volatility Band Length", group=grp_tdi)
tdi_band_mult = input.float(1.618, "TDI: Volatility Band Multiplier", step=0.1, group=grp_tdi)

// --- (NEW) SESSION SETTINGS ---
grp_sess = "Session Settings"
show_sessions = input.bool(true, "Show Session Backgrounds", group=grp_sess)
// Asia (Tokyo) default: 09:00 - 15:00 JST
asia_sess_time = input.session("0900-1500", "Asia Session Time", group=grp_sess)
asia_color = input.color(color.new(color.yellow, 92), "Asia Color", group=grp_sess)

// London default: 08:00 - 16:30 London Time
london_sess_time = input.session("0800-1630", "London Session Time", group=grp_sess)
london_color = input.color(color.new(color.green, 92), "London Color", group=grp_sess)

// New York default: 08:00 - 17:00 New York Time
ny_sess_time = input.session("0800-1700", "New York Session Time", group=grp_sess)
ny_color = input.color(color.new(color.red, 92), "New York Color", group=grp_sess)

// Session Trading Controls
use_session_filter = input.bool(false, "Filter by Session (Enable Trading Only in Selected Sessions)", group=grp_sess,
     tooltip="When enabled, entries will be allowed only during the selected sessions below.")
trade_asia = input.bool(true, "Trade Asia Session", group=grp_sess)
trade_london = input.bool(true, "Trade London Session", group=grp_sess)
trade_ny = input.bool(true, "Trade New York Session", group=grp_sess)


// --- STRATEGY DECLARATION ---
strategy("Test Session FopTun PA Pullback v2 + Sessions",
     overlay=true,
     shorttitle="Test_Session_FopTun_PA_Sess",
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     commission_value=0,
     commission_type=strategy.commission.percent,
     slippage=2)


// --- 2. CALCULATIONS ---
fast_ma = ta.ema(close, fast_len)
slow_ma = ta.ema(close, slow_len)
atr = ta.atr(atr_len)

// Calculate TP Multiplier from SL and RR
float tp_multiplier = sl_multiplier * rr_ratio

// Calculate ADX
[_, _, adx] = ta.dmi(dmi_len, adx_smoothing_len)

// Calculate Volume MA
volume_ma = ta.sma(volume, volume_ma_len)

// Calculate TDI and Volatility Bands
rsi = ta.rsi(close, tdi_rsi_len)
tdi_price_line = ta.sma(rsi, tdi_price_len)  // TDI Green
tdi_mbl = ta.sma(rsi, tdi_mbl_len)          // TDI Yellow (Market Base Line)
tdi_band_basis = ta.sma(rsi, tdi_band_len)
tdi_band_dev = ta.stdev(rsi, tdi_band_len) * tdi_band_mult
tdi_upper_band = tdi_band_basis + tdi_band_dev
tdi_lower_band = tdi_band_basis - tdi_band_dev

// 2.5 Session State (used for both visuals and trading filter)
// Use specific market timezones for each session definition
bool in_asia = not na(time(timeframe.period, asia_sess_time, "Asia/Tokyo"))
bool in_london = not na(time(timeframe.period, london_sess_time, "Europe/London"))
bool in_ny = not na(time(timeframe.period, ny_sess_time, "America/New_York"))
// Combined session pass condition for entry logic
bool session_pass = not use_session_filter or (trade_asia and in_asia) or (trade_london and in_london) or (trade_ny and in_ny)


// --- 3. STRATEGY LOGIC ---

// 3.1. Trend Definition
// EMA Trend
bool ema_uptrend = fast_ma > slow_ma
bool ema_downtrend = fast_ma < slow_ma

// TDI Trend (Base)
bool tdi_uptrend_base = tdi_price_line > tdi_mbl
bool tdi_downtrend_base = tdi_price_line < tdi_mbl

// TDI Bands Check (Not Overbought/Oversold)
bool tdi_not_overbought = tdi_price_line < tdi_upper_band
bool tdi_not_oversold = tdi_price_line > tdi_lower_band

// Combined TDI Filter
bool tdi_filter_buy = tdi_uptrend_base and (not use_tdi_band_filter or tdi_not_overbought)
bool tdi_filter_sell = tdi_downtrend_base and (not use_tdi_band_filter or tdi_not_oversold)

// Final Trend Logic
bool is_uptrend = ema_uptrend and (not use_tdi_filter or tdi_filter_buy)
bool is_downtrend = ema_downtrend and (not use_tdi_filter or tdi_filter_sell)


// 3.2. Pullback Conditions
bool pullback_buy_check = close[1] < fast_ma[1]
bool pullback_sell_check = close[1] > fast_ma[1]

// 3.3. Sideways Filter Logic
bool is_trending = adx > adx_threshold
bool filter_passed = (not use_adx_filter) or is_trending

// 3.4. Entry Triggers
bool buy_trigger = is_uptrend and pullback_buy_check and (close > fast_ma) and filter_passed
bool sell_trigger = is_downtrend and pullback_sell_check and (close < fast_ma) and filter_passed


// --- 4. ORDER MANAGEMENT ---

// Variables for Fixed Stop Loss / TP
var float long_stop_price = na
var float long_tp_price = na
var float short_stop_price = na
var float short_tp_price = na

// Variables for Trailing Stop
var float long_trail_act_price = na
var float long_trail_offset_ticks = na
var float short_trail_act_price = na
var float short_trail_offset_ticks = na

// --- ENTRY EXECUTION ----
// Gate actual orders by session_pass so entries occur only in allowed sessions
if (buy_trigger and strategy.position_size == 0 and session_pass)
    // Calculate Fixed SL/TP
    long_stop_price := close - (atr * sl_multiplier)
    long_tp_price := close + (atr * tp_multiplier)

    // Calculate Trailing Values at Entry
    // Activation Price: Current Price + (ATR * Multiplier)
    long_trail_act_price := close + (atr * trail_activation_mult)
    // Offset: Convert ATR distance to "Ticks" for strategy.exit
    long_trail_offset_ticks := (atr * trail_offset_mult) / syminfo.mintick

    strategy.entry("Buy", strategy.long)

if (sell_trigger and strategy.position_size == 0 and session_pass)
    // Calculate Fixed SL/TP
    short_stop_price := close + (atr * sl_multiplier)
    short_tp_price := close - (atr * tp_multiplier)

    // Calculate Trailing Values at Entry
    // Activation Price: Current Price - (ATR * Multiplier)
    short_trail_act_price := close - (atr * trail_activation_mult)
    // Offset: Convert ATR distance to "Ticks"
    short_trail_offset_ticks := (atr * trail_offset_mult) / syminfo.mintick

    strategy.entry("Sell", strategy.short)

// --- EXIT EXECUTION ---
// If use_trailing is true, pass the calculated values. If false, pass 'na' to disable trailing.
if (strategy.position_size > 0)
    strategy.exit("Long Exit", from_entry="Buy",
         stop=long_stop_price,
         limit=long_tp_price,
         trail_price = use_trailing ? long_trail_act_price : na,
         trail_offset = use_trailing ? long_trail_offset_ticks : na)

if (strategy.position_size < 0)
    strategy.exit("Short Exit", from_entry="Sell",
         stop=short_stop_price,
         limit=short_tp_price,
         trail_price = use_trailing ? short_trail_act_price : na,
         trail_offset = use_trailing ? short_trail_offset_ticks : na)


// --- 5. PLOTTING (VISUALS) ---

// 5.1. Plot EMAs
plot(fast_ma, "Fast EMA", color=color.new(#ffffff, 0), linewidth=2)
plot(slow_ma, "Slow EMA", color=color.new(#ff0000, 0), linewidth=2)

// 5.2a. Logic for Signal Label Color (Volume Check)
bool pass_vol_check = (not use_volume_filter) or (volume > volume_ma)
color buy_label_color = pass_vol_check ? color.new(color.green, 0) : color.new(color.blue, 0)
color sell_label_color = pass_vol_check ? color.new(color.red, 0) : color.new(color.blue, 0)

// 5.2. Plot Signal Labels "B" and "S"
plotshape(buy_trigger,
     style=shape.labelup,
     location=location.belowbar,
     color=buy_label_color,
     text="B",
     textcolor=color.new(color.white, 0),
     size=size.tiny,
     title="Buy Signal")

plotshape(sell_trigger,
     style=shape.labeldown,
     location=location.abovebar,
     color=sell_label_color,
     text="S",
     textcolor=color.new(color.white, 0),
     size=size.tiny,
     title="Sell Signal")

// 5.3. Background Color based on Trend
color bg_color = filter_passed ? (is_uptrend ? color.new(color.blue, 90) : is_downtrend ? color.new(color.orange, 90) : na) : color.new(color.gray, 90)
bgcolor(bg_color, title="Trend Background")

// 5.4. (NEW) Session Backgrounds
// Use the previously computed in_asia/in_london/in_ny to draw backgrounds

bgcolor(show_sessions and in_asia ? asia_color : na, title="Asia Session Background")
bgcolor(show_sessions and in_london ? london_color : na, title="London Session Background")
bgcolor(show_sessions and in_ny ? ny_color : na, title="NY Session Background")